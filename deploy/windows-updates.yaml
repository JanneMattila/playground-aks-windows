
apiVersion: v1
kind: ConfigMap
metadata:
  name: windows-update-script
data:
  check-updates.ps1: |
    Write-Host "Checking for nuget provider is installed..."
    $nugetProvider = Get-PackageProvider -Name NuGet -ErrorAction SilentlyContinue

    if (-not $nugetProvider) {
        Write-Host "NuGet provider not found. Installing NuGet provider..."
        Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Force
    }

    Write-Host "Checking for PSWindowsUpdate module..."
    # Ensure PSWindowsUpdate module is installed
    if (-not (Get-Module -ListAvailable -Name PSWindowsUpdate)) {
      Write-Host "PSWindowsUpdate module not found. Installing..."
      Install-Module -Name PSWindowsUpdate -Force -Scope CurrentUser -SkipPublisherCheck
      
      # Refresh environment module path
      $env:PSModulePath = [System.Environment]::GetEnvironmentVariable("PSModulePath", "Machine") + ";" + [System.Environment]::GetEnvironmentVariable("PSModulePath", "User")
      
      # Verify installation
      $module = Get-Module -ListAvailable -Name PSWindowsUpdate
      if (-not $module) {
        Write-Error "Failed to install PSWindowsUpdate module"
        exit 1
      }
      Write-Host "PSWindowsUpdate module installed successfully at: $($module.ModuleBase)"
    }

    Import-Module PSWindowsUpdate -ErrorAction Stop

    Write-Host "Checking for Windows updates..."
    $updates = Get-WindowsUpdate

    if ($updates) {
        Write-Host "Updates available:"
          $updates | Format-Table -Property KBArticle, Title, Size, IsDownloaded

          Write-Host "Applying updates and restarting if necessary"

          Get-WindowsUpdate -Install -AcceptAll -AutoReboot -Verbose
    } else {
        Write-Host "Your system is up to date."
    }

    Start-Sleep -Seconds 2147483
---
# https://learn.microsoft.com/en-us/azure/aks/use-windows-hpc
# https://kubernetes.io/docs/tasks/configure-pod-container/create-hostprocess-pod/
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: windows-updates
  labels:
    app: windows-updates
spec:
  selector:
    matchLabels:
      app: windows-updates
  template:
    metadata:
      name: windows-updates
      labels:
        app: windows-updates
    spec:
      nodeSelector:
        "kubernetes.io/os": windows
      securityContext:
        windowsOptions:
          hostProcess: true
          runAsUserName: "NT AUTHORITY\\SYSTEM"
      hostNetwork: true
      containers:
        - name: powershell
          # https://learn.microsoft.com/en-us/virtualization/windowscontainers/manage-containers/container-base-images
          # https://github.com/microsoft/windows-host-process-containers-base-image
          image: mcr.microsoft.com/oss/kubernetes/windows-host-process-containers-base-image:v1.0.0 
          command:
            - powershell.exe
            - -File
            - "C:\\scripts\\check-updates.ps1"
          imagePullPolicy: Always
          volumeMounts:
            - name: script-volume
              mountPath: C:\\scripts
      volumes:
        - name: script-volume
          configMap:
            name: windows-update-script
